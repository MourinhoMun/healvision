# HealVision 开发进展记录

## 日期：2026-02-19

---

## 本次完成的工作

### 一、授权后端（服务器 43.153.209.145）

1. **新建通用扣费接口** `/api/v1/proxy/use`
   - 文件路径：`/var/www/peng-ip-website/app/api/v1/proxy/use/route.ts`
   - 根据请求中的 `software` 参数查 Tool 表，自动读取积分数扣费
   - 以后新增软件只需在管理后台工具管理里加一条记录，不用改代码

2. **管理后台添加 HealVision 工具**
   - 名称：HealVision AI
   - 英文名（nameEn）：`healvision`
   - 每次消耗积分：10
   - 状态：active

3. **已构建并重启**（pm2 restart peng-ip-website）

---

### 二、HealVision 服务端

| 操作 | 文件 | 说明 |
|------|------|------|
| 修改 | `.env` | 新增 `LICENSE_BACKEND_URL=https://pengip.com` |
| 修改 | `.env.example` | 同上 |
| 修改 | `server/src/config.ts` | 新增 `licenseBackendUrl` 配置项 |
| 新建 | `server/src/routes/license.ts` | 授权代理路由（activate/balance/deduct） |
| 新建 | `server/src/middleware/licenseCheck.ts` | 积分校验中间件，生成前查余额，成功后扣积分 |
| 修改 | `server/src/routes/index.ts` | 注册 license 路由 |
| 修改 | `server/src/routes/generate.ts` | 四个 AI 路由添加 licenseCheck 中间件 |
| 修改 | `server/src/index.ts` | 生产模式托管 client/dist 静态文件 |

---

### 三、HealVision 客户端

| 操作 | 文件 | 说明 |
|------|------|------|
| 新建 | `client/src/api/license.ts` | 激活和查余额 API |
| 新建 | `client/src/stores/authStore.ts` | 授权状态管理（token/余额/激活/充值） |
| 新建 | `client/src/pages/ActivationPage.tsx` | 激活页面 |
| 新建 | `client/src/components/shared/RechargeDialog.tsx` | 充值弹窗 |
| 修改 | `client/src/App.tsx` | 路由守卫，未激活显示激活页 |
| 修改 | `client/src/api/client.ts` | 请求拦截器（自动带 token，401/402/403 处理） |
| 修改 | `client/src/components/layout/Header.tsx` | 显示余额 + 充值按钮 |
| 修改 | `client/src/pages/SettingsPage.tsx` | 设置页新增充值区域 |
| 修改 | `client/src/stores/workbenchStore.ts` | AI 操作后刷新余额 |
| 修改 | `client/src/pages/TextToImagePage.tsx` | 生成后刷新余额 |
| 修改 | `client/vite.config.ts` | 生产构建 base 改为 `/` |

---

### 四、打包发布

| 文件 | 说明 |
|------|------|
| `build_release.bat` | 一键构建 + 下载便携 Node.js + 打包 zip |
| `release_templates/start.bat` | 客户启动脚本 |
| `release_templates/使用说明.txt` | 客户使用说明 |
| `shared/package.json` | 添加了 no-op build 脚本 |

---

## 待办事项

- [ ] 启动测试完整流程（激活 → 查余额 → AI 生成 → 扣积分 → 充值）
- [ ] 运行 `build_release.bat` 生成发布包
- [ ] 解压发布包到另一目录测试 start.bat
- [ ] 项目存在一些预有的 TypeScript 编译错误（与本次改动无关），如需修复可后续处理

---

## 服务器信息

- IP：43.153.209.145
- SSH 端口：22
- 用户名：ubuntu
- 项目路径：`/var/www/peng-ip-website`
- 进程管理：pm2（进程名 peng-ip-website）
- 域名：pengip.com
